// Car marketplace – Supabase Postgres
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User profile – sync with Supabase Auth via authId
model User {
  id        String   @id @default(cuid())
  authId    String?  @unique // Supabase auth user id
  email     String   @unique
  name      String?
  image     String?  // avatar URL (Cloudinary or Supabase storage)
  phone     String?
  location  String?  // e.g. "Sydney, NSW"
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listings        Listing[]
  savedListings    SavedListing[]
  conversationsAsBuyer  Conversation[] @relation("BuyerConversations")
  conversationsAsSeller Conversation[] @relation("SellerConversations")
  sentMessages     Message[]           @relation("SentMessages")
  dealerships      Dealership[]
}

// Dealership profile – a user can own one or more dealerships
model Dealership {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique // URL-friendly identifier
  description    String?
  location       String   // e.g. "Dhanmondi, Dhaka"
  operatingHours String?  // e.g. "Mon-Sat 9AM-6PM"
  phone          String?
  logoUrl        String?  // dealership logo/banner
  coverUrl       String?  // cover image
  ownerId        String
  owner          User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  vehicles       DealershipVehicle[]

  @@index([ownerId])
  @@index([slug])
}

// Vehicle in a dealership's catalog
model DealershipVehicle {
  id             String   @id @default(cuid())
  dealershipId   String
  dealership     Dealership @relation(fields: [dealershipId], references: [id], onDelete: Cascade)
  title          String
  make           String
  model          String
  year           Int
  mileage        Int?
  price          Decimal  @db.Decimal(12, 2)
  bodyType       String?
  transmission   String?
  drivetrain     String?
  color          String?
  description    String?
  condition      String?  // "new" | "used" | "certified"
  status         String   @default("available") // available | sold | reserved
  imageUrls      String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([dealershipId])
  @@index([make, model])
  @@index([status])
}

model Listing {
  id          String   @id @default(cuid())
  title       String
  description String?
  price       Decimal  @db.Decimal(12, 2)
  make        String
  model       String
  year        Int
  mileage     Int?
  bodyType    String?  // Sedan, SUV, Ute, etc.
  transmission String?  // Automatic, Manual
  drivetrain   String?  // FWD, RWD, AWD, 4WD
  color        String?  // White, Black, Silver, etc.
  location    String?  // e.g. "Dhanmondi, Dhaka"
  latitude    Float?   // for map pin (Dhaka city)
  longitude   Float?   // for map pin (Dhaka city)
  status      String   @default("active") // draft | active | sold | expired
  imageUrls   String[]
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  savedBy     SavedListing[]
  conversations Conversation[]

  @@index([userId])
  @@index([make, model])
  @@index([status])
  @@index([createdAt])
}

// Saved/favorite listings per user
model SavedListing {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
}

// Conversation between buyer and seller about a listing
model Conversation {
  id        String   @id @default(cuid())
  listingId String
  buyerId   String
  sellerId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyer   User    @relation("BuyerConversations", fields: [buyerId], references: [id], onDelete: Cascade)
  seller  User    @relation("SellerConversations", fields: [sellerId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([listingId, buyerId]) // one conversation per listing per buyer
  @@index([buyerId])
  @@index([sellerId])
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
}
